# NewAPI 监控与风控系统验收清单

本文档提供了系统验收的详细清单，确保所有功能模块正常工作。

## 📋 验收概览

### 系统信息
- **项目名称**: NewAPI 监控与风控系统
- **版本**: v1.0.0
- **验收日期**: ___________
- **验收人员**: ___________

### 验收标准
- ✅ **通过**: 功能完全正常
- ⚠️ **警告**: 功能基本正常，有轻微问题
- ❌ **失败**: 功能异常或不可用

---

## 🏗️ 基础设施验收

### Docker 容器服务

| 服务名称 | 状态检查 | 健康检查 | 日志检查 | 验收结果 |
|---------|---------|---------|---------|---------|
| redis | [ ] 运行中 | [ ] 健康 | [ ] 无错误 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| api | [ ] 运行中 | [ ] 健康 | [ ] 无错误 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| worker | [ ] 运行中 | [ ] 健康 | [ ] 无错误 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| frontend | [ ] 运行中 | [ ] 健康 | [ ] 无错误 | [ ] ✅ [ ] ⚠️ [ ] ❌ |

**验收命令**:
```bash
# 检查服务状态
docker-compose ps

# 检查服务健康
./scripts/health_check.sh --verbose

# 查看服务日志
docker-compose logs --tail=50 [service-name]
```

### 数据库连接

| 检查项目 | 验收标准 | 验收结果 |
|---------|---------|---------|
| MySQL 连接 | [ ] API 可连接到 newapi 数据库 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 只读用户权限 | [ ] newapi_ro 用户权限正确 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 聚合用户权限 | [ ] newapi_agg 用户权限正确 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| Redis 连接 | [ ] 缓存服务正常 | [ ] ✅ [ ] ⚠️ [ ] ❌ |

**验收命令**:
```bash
# 检查数据库连接
curl http://localhost/api/health

# 检查数据库性能
mysql -h your-host -u root -p < scripts/performance_check.sql
```

---

## 🖥️ 前端界面验收

### 页面访问

| 页面 | URL | 加载正常 | 布局正确 | 交互正常 | 验收结果 |
|-----|-----|---------|---------|---------|---------|
| 主页 | / | [ ] | [ ] | [ ] | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 总览页 | /dashboard | [ ] | [ ] | [ ] | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| Top排行 | /top | [ ] | [ ] | [ ] | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 热力图 | /heatmap | [ ] | [ ] | [ ] | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 异常中心 | /anomalies | [ ] | [ ] | [ ] | [ ] ✅ [ ] ⚠️ [ ] ❌ |

### 组件功能

| 组件 | 功能描述 | 验收标准 | 验收结果 |
|-----|---------|---------|---------|
| 导航菜单 | 页面切换 | [ ] 菜单项正确，切换正常 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 时间筛选器 | 时间范围选择 | [ ] 预设范围和自定义范围都正常 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 刷新按钮 | 数据刷新 | [ ] 点击后数据重新加载 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 导出功能 | CSV导出 | [ ] 能够下载CSV文件 | [ ] ✅ [ ] ⚠️ [ ] ❌ |

---

## 📊 数据展示验收

### Dashboard 总览页

| 功能模块 | 验收标准 | 验收结果 |
|---------|---------|---------|
| KPI 指标卡 | [ ] 显示总请求数、Token数、用户数、Token种类数 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 趋势图表 | [ ] 显示请求数、Token数、用户数的时序趋势 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 图表交互 | [ ] 鼠标悬停显示详细数据 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 时间粒度 | [ ] 根据时间范围自动调整粒度 | [ ] ✅ [ ] ⚠️ [ ] ❌ |

### Top 排行页

| 功能模块 | 验收标准 | 验收结果 |
|---------|---------|---------|
| 维度切换 | [ ] 支持用户、Token、模型、通道维度 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 指标切换 | [ ] 支持Token数、请求数、配额指标 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 排行图表 | [ ] 显示Top 20柱状图 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 详细表格 | [ ] 显示完整排行数据 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 表格排序 | [ ] 支持按各列排序 | [ ] ✅ [ ] ⚠️ [ ] ❌ |

### 热力图页

| 功能模块 | 验收标准 | 验收结果 |
|---------|---------|---------|
| 热力图显示 | [ ] 按小时和星期显示热力图 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 指标切换 | [ ] 支持请求数、Token数、用户数 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 颜色映射 | [ ] 颜色深浅正确反映数值大小 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 工具提示 | [ ] 鼠标悬停显示具体数值 | [ ] ✅ [ ] ⚠️ [ ] ❌ |

### 异常中心页

| 功能模块 | 验收标准 | 验收结果 |
|---------|---------|---------|
| 规则标签页 | [ ] 显示4种风控规则的标签页 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 异常列表 | [ ] 显示检测到的异常记录 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 详情弹窗 | [ ] 点击查看详情显示完整信息 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 异常计数 | [ ] 标签页显示异常数量 | [ ] ✅ [ ] ⚠️ [ ] ❌ |

---

## 🔧 API 接口验收

### 核心接口

| 接口 | 功能 | 验收标准 | 验收结果 |
|-----|-----|---------|---------|
| GET /api/health | 健康检查 | [ ] 返回 ok: true | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| GET /api/stats/series | 时序数据 | [ ] 返回正确格式的时序数据 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| GET /api/stats/top | TopN数据 | [ ] 支持所有维度和指标组合 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| GET /api/stats/anomalies | 异常数据 | [ ] 支持所有风控规则 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| GET /api/export/csv | 数据导出 | [ ] 返回正确的CSV文件 | [ ] ✅ [ ] ⚠️ [ ] ❌ |

### 性能要求

| 指标 | 要求 | 实际值 | 验收结果 |
|-----|-----|-------|---------|
| API响应时间 | < 5秒 | _____ | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 并发处理 | 支持10个并发请求 | _____ | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 缓存命中率 | > 80% | _____ | [ ] ✅ [ ] ⚠️ [ ] ❌ |

**验收命令**:
```bash
# 运行功能测试
python3 scripts/functional_test.py --url http://localhost --verbose

# 性能测试
ab -n 100 -c 10 http://localhost/api/health
```

---

## 🤖 Worker 服务验收

### 数据聚合

| 功能 | 验收标准 | 验收结果 |
|-----|---------|---------|
| 小时级聚合 | [ ] 每5分钟执行一次聚合任务 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 聚合数据写入 | [ ] 数据正确写入 agg_usage_hourly 表 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 多维度聚合 | [ ] 支持全局、用户、模型、通道维度 | [ ] ✅ [ ] ⚠️ [ ] ❌ |

### 风控规则

| 规则 | 验收标准 | 验收结果 |
|-----|---------|---------|
| 突发频率检测 | [ ] 检测Token短时间内高频请求 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 共享Token检测 | [ ] 检测多用户共享Token | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 同IP多账号检测 | [ ] 检测单IP下多账号行为 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 超大请求检测 | [ ] 基于3σ原则检测异常请求 | [ ] ✅ [ ] ⚠️ [ ] ❌ |

### 告警机制

| 功能 | 验收标准 | 验收结果 |
|-----|---------|---------|
| Webhook告警 | [ ] 能够发送告警到配置的Webhook | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 告警冷却 | [ ] 相同异常在冷却期内不重复告警 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 批量告警 | [ ] 大量异常时发送汇总告警 | [ ] ✅ [ ] ⚠️ [ ] ❌ |

**验收命令**:
```bash
# 检查Worker日志
docker-compose logs -f worker

# 检查聚合数据
mysql -h your-host -u newapi_ro -p -e "SELECT COUNT(*) FROM \`new-api\`.agg_usage_hourly WHERE hour_bucket >= DATE_SUB(NOW(), INTERVAL 24 HOUR);"
```

---

## 🔒 安全性验收

### 数据库安全

| 检查项目 | 验收标准 | 验收结果 |
|---------|---------|---------|
| 最小权限原则 | [ ] 只读用户仅有SELECT权限 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 密码安全 | [ ] 使用强密码 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 连接加密 | [ ] 使用SSL连接（如适用） | [ ] ✅ [ ] ⚠️ [ ] ❌ |

### 应用安全

| 检查项目 | 验收标准 | 验收结果 |
|---------|---------|---------|
| 环境变量 | [ ] 敏感信息通过环境变量配置 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 日志安全 | [ ] 日志中无敏感信息泄露 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 访问控制 | [ ] 适当的访问控制机制 | [ ] ✅ [ ] ⚠️ [ ] ❌ |

---

## 📈 运维功能验收

### 监控与日志

| 功能 | 验收标准 | 验收结果 |
|-----|---------|---------|
| 健康检查 | [ ] 提供健康检查端点 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 结构化日志 | [ ] 使用JSON格式的结构化日志 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 错误处理 | [ ] 适当的错误处理和日志记录 | [ ] ✅ [ ] ⚠️ [ ] ❌ |

### 备份与恢复

| 功能 | 验收标准 | 验收结果 |
|-----|---------|---------|
| 数据备份 | [ ] 备份脚本正常工作 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 数据恢复 | [ ] 恢复脚本正常工作 | [ ] ✅ [ ] ⚠️ [ ] ❌ |
| 定期清理 | [ ] 清理脚本正常工作 | [ ] ✅ [ ] ⚠️ [ ] ❌ |

**验收命令**:
```bash
# 测试备份
./scripts/backup.sh

# 测试恢复（在测试环境）
./scripts/restore.sh backup_file.sql.gz --dry-run

# 测试清理（在测试环境）
mysql -h your-host -u root -p < scripts/cleanup_data.sql
```

---

## 📝 验收总结

### 整体评估

| 模块 | 通过率 | 评级 | 备注 |
|-----|-------|------|------|
| 基础设施 | ___% | [ ] A [ ] B [ ] C [ ] D | |
| 前端界面 | ___% | [ ] A [ ] B [ ] C [ ] D | |
| 数据展示 | ___% | [ ] A [ ] B [ ] C [ ] D | |
| API接口 | ___% | [ ] A [ ] B [ ] C [ ] D | |
| Worker服务 | ___% | [ ] A [ ] B [ ] C [ ] D | |
| 安全性 | ___% | [ ] A [ ] B [ ] C [ ] D | |
| 运维功能 | ___% | [ ] A [ ] B [ ] C [ ] D | |

### 验收结论

- [ ] ✅ **通过验收** - 系统完全满足要求，可以上线使用
- [ ] ⚠️ **有条件通过** - 系统基本满足要求，有轻微问题需要修复
- [ ] ❌ **不通过验收** - 系统存在重大问题，需要修复后重新验收

### 遗留问题

| 问题描述 | 严重程度 | 负责人 | 预计解决时间 |
|---------|---------|-------|-------------|
| | [ ] 高 [ ] 中 [ ] 低 | | |
| | [ ] 高 [ ] 中 [ ] 低 | | |
| | [ ] 高 [ ] 中 [ ] 低 | | |

### 签字确认

- **开发负责人**: _________________ 日期: _________
- **测试负责人**: _________________ 日期: _________
- **产品负责人**: _________________ 日期: _________
- **运维负责人**: _________________ 日期: _________

---

**备注**: 本验收清单应在系统部署完成后逐项检查，确保所有功能正常工作后方可上线使用。
